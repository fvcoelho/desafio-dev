@page "/"
@rendermode InteractiveServer
@inject HttpClient Http
@inject IConfiguration Configuration
@using System.Globalization

<PageTitle>CNAB File Upload</PageTitle>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">CNAB File Upload</h3>
                </div>
                <div class="card-body">
                <div class="mb-3">
                        <label for="apiKeyInput" class="form-label">API Key</label>
                        <input id="apiKeyInput" @bind="apiKey" class="form-control" placeholder="Enter API Key" />
                        <div class="form-text">
                            Required for upload and clear operations. Default: <code>financeapp-secret-key</code>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select CNAB File (.txt) <span class="text-danger">*</span></label>
                        <InputFile id="fileInput" OnChange="@HandleFileSelected" class="@($"form-control {(showFileValidation && selectedFile == null ? "is-invalid" : "")}")" accept=".txt" />
                        @if (showFileValidation && selectedFile == null)
                        {
                            <div class="invalid-feedback d-block">
                                Please select a CNAB file to upload.
                            </div>
                        }
                        <div class="form-text">
                            Don't have a CNAB file? <a href="/CNAB.txt" download="CNAB.txt" class="text-decoration-none">Download a sample file</a>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <strong>Error:</strong> @errorMessage
                        </div>
                    }

                    @if (uploadResult != null && uploadResult.Success)
                    {
                        <div class="alert alert-success" role="alert">
                            <h5>Upload Successful!</h5>
                            <p class="mb-0">
                                <strong>@uploadResult.TransactionsImported</strong> transactions imported from
                                <strong>@uploadResult.StoresProcessed</strong> stores
                            </p>
                        </div>
                    }

                    @if (clearSuccess)
                    {
                        <div class="alert alert-success" role="alert">
                            <h5>Data Cleared!</h5>
                            <p class="mb-0">All transactions and stores have been cleared successfully.</p>
                        </div>
                    }

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" @onclick="UploadFile" disabled="@isUploading">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading...</span>
                            }
                            else
                            {
                                <span>Upload File</span>
                            }
                        </button>
                        <button class="btn btn-danger btn-lg" @onclick="ClearData" disabled="@isClearing">
                            @if (isClearing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Clearing...</span>
                            }
                            else
                            {
                                <span>Clear Data</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            @if (stores != null && stores.Any())
            {
                <div class="card mt-4">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Store Balances</h4>
                    </div>
                    <div class="card-body">
                        @foreach (var store in stores)
                        {
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="mb-0">@store.StoreName</h5>
                                    <small class="text-muted">Owner: @store.OwnerName</small>
                                </div>
                                <div class="card-body">
                                    <h6>Balance:
                                        <span class="@(store.Balance >= 0 ? "text-success" : "text-danger")">
                                            @store.Balance.ToString("C2", new CultureInfo("pt-BR"))
                                        </span>
                                    </h6>
                                    <p><strong>Transactions: @store.Transactions.Count</strong></p>

                                    @if (expandedStores.Contains(store.StoreId))
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Date</th>
                                                        <th>Time</th>
                                                        <th>Value</th>
                                                        <th>CPF</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var transaction in store.Transactions)
                                                    {
                                                        <tr>
                                                            <td>@transaction.Type</td>
                                                            <td>@transaction.Date.ToString("yyyy-MM-dd")</td>
                                                            <td>@transaction.Time</td>
                                                            <td class="@(transaction.SignedValue >= 0 ? "text-success" : "text-danger")">
                                                                @transaction.SignedValue.ToString("C2", new CultureInfo("pt-BR"))
                                                            </td>
                                                            <td>@transaction.Cpf</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" @onclick="() => CollapseStore(store.StoreId)">
                                            Hide Transactions
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick="() => ExpandStore(store.StoreId)">
                                            Show Transactions
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Quick Install</h4>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">
                            <strong>Clone the repository</strong>
                            <pre class="bg-light p-2 rounded mt-1 mb-0"><code>git clone -b main_deploy https://github.com/fvcoelho/desafio-dev</code></pre>
                        </li>
                        <li class="mb-2">
                            <strong>Navigate to the project</strong>
                            <pre class="bg-light p-2 rounded mt-1 mb-0"><code>cd desafio-dev</code></pre>
                        </li>
                        <li>
                            <strong>Run with Docker</strong>
                            <pre class="bg-light p-2 rounded mt-1 mb-0"><code>docker-compose up -d --build</code></pre>
                            <small class="text-muted">Then open <a href="http://localhost:5001" target="_blank">http://localhost:5001</a></small>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private bool isClearing = false;
    private bool clearSuccess = false;
    private bool showFileValidation = false;
    private string? errorMessage;
    private UploadResponse? uploadResult;
    private List<StoreBalance>? stores;
    private HashSet<int> expandedStores = new();
    private string apiKey = "financeapp-secret-key";

    protected override async Task OnInitializedAsync()
    {
        apiKey = Configuration["ApiSettings:ApiKey"] ?? "financeapp-secret-key";
        await LoadStoreBalances();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        showFileValidation = false;
        errorMessage = null;
        uploadResult = null;
        StateHasChanged();
    }

    private async Task UploadFile()
    {
        showFileValidation = true;
        if (selectedFile == null) return;

        isUploading = true;
        errorMessage = null;
        uploadResult = null;
        stores = null;
        clearSuccess = false;

        try
        {
            var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5118";

            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)); // 10MB max
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("text/plain");
            content.Add(fileContent, "file", selectedFile.Name);

            using var request = new HttpRequestMessage(HttpMethod.Post, $"{apiBaseUrl}/api/cnab/upload");
            request.Headers.Add("X-API-Key", apiKey);
            request.Content = content;

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                uploadResult = await response.Content.ReadFromJsonAsync<UploadResponse>();

                if (uploadResult?.Success == true)
                {
                    await LoadStoreBalances();
                }
            }
            else
            {
                errorMessage = $"Upload failed: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task LoadStoreBalances()
    {
        try
        {
            var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5118";
            stores = await Http.GetFromJsonAsync<List<StoreBalance>>($"{apiBaseUrl}/api/stores/balances");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading balances: {ex.Message}";
        }
    }

    private void ExpandStore(int storeId)
    {
        expandedStores.Add(storeId);
    }

    private void CollapseStore(int storeId)
    {
        expandedStores.Remove(storeId);
    }

    private async Task ClearData()
    {
        isClearing = true;
        errorMessage = null;
        clearSuccess = false;
        showFileValidation = false;

        try
        {
            var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5118";

            using var request = new HttpRequestMessage(HttpMethod.Delete, $"{apiBaseUrl}/api/cnab/clear");
            request.Headers.Add("X-API-Key", apiKey);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                stores = null;
                uploadResult = null;
                selectedFile = null;
                expandedStores.Clear();
                clearSuccess = true;
            }
            else
            {
                errorMessage = $"Clear failed: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isClearing = false;
        }
    }

    public class UploadResponse
    {
        public bool Success { get; set; }
        public int TransactionsImported { get; set; }
        public int StoresProcessed { get; set; }
        public string? ErrorMessage { get; set; }
    }

    public class StoreBalance
    {
        public int StoreId { get; set; }
        public string StoreName { get; set; } = string.Empty;
        public string OwnerName { get; set; } = string.Empty;
        public List<Transaction> Transactions { get; set; } = new();
        public decimal Balance { get; set; }
    }

    public class Transaction
    {
        public string Type { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public string Time { get; set; } = string.Empty;
        public decimal Value { get; set; }
        public decimal SignedValue { get; set; }
        public string Cpf { get; set; } = string.Empty;
        public string CardNumber { get; set; } = string.Empty;
    }
}
